<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Multitech Conduit Getting Started</title>

    <link href="images/favicon.ico" rel="icon" type="image/ico" />
    <link href="stylesheets/screen.css" rel="stylesheet" type="text/css" media="screen" />
    <link href="stylesheets/print.css" rel="stylesheet" type="text/css" media="print" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
      <script src="javascripts/all.js" type="text/javascript"></script>

  </head>

  <body class="index">
    <a href="#" id="nav-button">
      <span>
        NAV
        <img src="images/navbar.png" />
      </span>
    </a>
    <div class="tocify-wrapper">
      <img src="images/TheThingsRond.png" />
      <p id="GettingStarted">Getting Started</p>
      <div class="separator separator-top"></div>
      <!--div class="platform-nav"-->
        <!--div class="nav-label">Platform</div-->
        <!--div class="platform-selector btn-group">
          <button class="btn btn-default" data-platform-name="ios">iOS</button>
          <button class="btn btn-default" data-platform-name="android">Android</button>
          <button class="btn btn-default" data-platform-name="web">Web</button>
        </div-->
        <!--div class="clear"></div-->
      <!--/div-->
      <!--div class="separator"></div-->
        <div class="search">
          <input type="text" class="search" id="input-search" placeholder="Search">
        </div>
        <ul class="search-results"></ul>
      <div id="toc">
      </div>
        <ul class="toc-footer">
            <li><a href='http://thethingsnetwork.org' target='_blank'>Want to know more about The Things Network?</a></li>
        </ul>
    </div>
    <div class="page-wrapper">
      <div class="dark-box"></div>
      <div class="content">
        
          <h1 id='welcome'>Welcome</h1>
<p>This tutorial will focus on Configuring the Multitech Conduit Gateway:</p>

<ul>
<li>Installing LoRa-mCard (MTAC-LORA) </li>
<li>Updating the packet-forwarder</li>
<li>Configuring the Packet-forwarder</li>
</ul>
<h2 id='the-hardware'>The Hardware</h2>
<table><thead>
<tr>
<th>MultiTech Conduit</th>
<th>MTAC-LORA</th>
</tr>
</thead><tbody>
<tr>
<td><img style='max-width: 350px;' src="images/multitech-conduit.png"></td>
<td><img style='max-width: 200px;' src="images/lora-mcard.png"></td>
</tr>
<tr>
<td><a href="http://www.multitech.net/developer/products/multiconnect-conduit-platform/">info</a></td>
<td><a href="http://www.multitech.net/developer/products/accessory-cards/mtac-lora/">info</a></td>
</tr>
</tbody></table>
<h1 id='inserting-the-mtac-lora-module'>Inserting the MTAC-LORA module</h1>
<ol>
<li>Disconnect power to the gateway device.</li>
<li>At the back of the housing, determine where you want to install the accessory card. 
You can install the card in either the AP1 or AP2 port. 
Remove the port cover and retain the screw.</li>
<li>Slide the card into the opening and push until you feel the card connector seat in the internal connector.</li>
<li>Use a small Phillips screwdriver to attach the card bracket to the housing with the screw from the port cover.</li>
</ol>

<p><img style = "display:inline" src="images/multitech-mcard.png"></p>
<h1 id='connecting-the-gateway'>Connecting the Gateway</h1>
<ol>
<li>Connect the antenna to the <code class="prettyprint">MTAC-LORA</code> module.</li>
<li>Connect the Ethernet cable</li>
<li>Connect the Power Suply</li>
<li>The gateway should now boot up</li>
</ol>
<h1 id='loging-into-the-gateway'>Loging into the Gateway</h1>
<p>The gateway can be configured by using the serial port.</p>

<ol>
<li>Connect the gateway to your computer with a Micro-USB-cable to the <strong>USB Device</strong> Port.</li>
<li>Open up a Serial monitor tool such as <a href="http://www.chiark.greenend.org.uk/~sgtatham/putty/download.html">putty</a>.</li>
<li>Configure the Serial monitor tool:

<ol>
<li>Select the right COM-Port</li>
<li>Enter the Baudrate of <code class="prettyprint">115200</code></li>
<li>Select for Flow Control: <code class="prettyprint">XON/XOFF</code></li>
</ol></li>
<li>Open the Serial monitor</li>
<li><ol>
<li><p>Log into the <strong>A.E.P. Gateway</strong>:</p>

<ol>
<li>The Login should appear. If not hit a random key.</li>
<li>Login with the following credentials:

<ol>
<li>Username: admin</li>
<li>Password: admin</li>
</ol></li>
<li>If the login was successful the commandline should appear: <code class="prettyprint">admin@mtcdt:~#</code>.</li>
</ol>
<pre class="highlight plaintext"><code>    _        _____     ____
   / \      | ____|   |  _ \
  / _ \     |  _|     | |_) |
 / ___ \  _ | |___  _ |  __/_
/_/   \_\(_)|_____|(_)|_|  (_)

MultiTech Systems Application Execution Platform with mLinux GNU/Linux

mLinux 3.1.0 mtcdt /dev/ttyGS0

Version: 1.1.2
Date: 2016-01-13T09:59:04
mtcdt login: admin
Password:
admin@mtcdt:~#
</code></pre></li>
<li><p>Log into the <strong>mLinux Gateway</strong>:</p>

<ol>
<li>The Login should appear. If not hit a random key.</li>
<li>Login with the following credentials:

<ol>
<li>Username: root</li>
<li>Password: root</li>
</ol></li>
<li>If the login was successful the commandline should appear: <code class="prettyprint">root@mtcdt:~#</code>.</li>
</ol>
<pre class="highlight plaintext"><code>           _     _
 _ __ ___ | |   (_)_ __  _   ___  __
| '_ ` _ \| |   | | '_ \| | | \ \/ /
| | | | | | |___| | | | | |_| |&gt;  &lt;
|_| |_| |_|_____|_|_| |_|\__,_/_/\_\

MultiTech Systems mLinux GNU/Linux
mLinux 3.1.0 mtcdt /dev/ttyGS0

mtcdt login: root
Password:
root@mtcdt:~#
</code></pre></li>
</ol></li>
</ol>
<h1 id='updating-the-lora-packet-forwarder'>Updating the Lora Packet Forwarder</h1>
<ol>
<li><p>Download <a href="http://www.multitech.net/developer/downloads/">here</a> the latest <code class="prettyprint">Lora-Packet-forwarder</code> and <code class="prettyprint">Lora-Network-Server</code> packet from the Multitech. The file should be similar to this:</p>

<ul>
<li><code class="prettyprint">lora-packet-forwarder_1.4.1-r9.1_arm926ejste.ipk</code></li>
<li><code class="prettyprint">lora-network-server_1.0.8-r0.0_mlinux.ipk</code></li>
</ul></li>
<li><p>Copy the file to a flashdrive.</p></li>
<li><p>Insert the flashdrive into the USB-Port of the Multitech gateway.</p></li>
<li><p>Now navigate in the gateway to the flashdrive:</p>

<ol>
<li>Navigate to the media folder: <code class="prettyprint">cd /media/</code></li>
<li>Navigate to the flashdirve: <code class="prettyprint">cd sda1</code>

<ol>
<li>It should be named <code class="prettyprint">sda1</code> or similar.</li>
</ol></li>
<li>Install the Lora-packet-forwarder using the <code class="prettyprint">opkg</code> package manager: <code class="prettyprint">opkg install ./lora-packet-forwarder_1.4.1-r9.1_arm926ejste.ipk</code></li>
<li>Install the Lora-network-server using the <code class="prettyprint">opkg</code> package manager: <code class="prettyprint">opkg install ./lora-network-server_1.0.8-r0.0_mlinux.ipk</code></li>
</ol>
<pre class="highlight plaintext"><code>admin@mtcdt:~# cd /media/sda1/
admin@mtcdt:/media/sda1# opkg install ./lora-packet-forwarder_1.4.1-r9.1_arm926ejste.ipk
Installing lora-packet-forwarder (1.4.1-r9.1) to root...
Configuring lora-packet-forwarder.
admin@mtcdt:/media/sda1# opkg install ./lora-network-server_1.0.8-r0.0_mlinux.ipk
Installing lora-network-server (1.0.8-r0.0) to root...
Stopping lora-network-server: start-stop-daemon: warning: failed to kill 1117: No such process
OK
update-rc.d: /etc/init.d/lora-network-server exists during rc.d purge (continuing)
Removing any system startup links for lora-network-server ...
/etc/rc0.d/K30lora-network-server
/etc/rc1.d/K30lora-network-server
/etc/rc2.d/S80lora-network-server
/etc/rc3.d/S80lora-network-server
/etc/rc4.d/S80lora-network-server
/etc/rc5.d/S80lora-network-server
/etc/rc6.d/K30lora-network-server
Configuring lora-network-server.
Adding system startup for /etc/init.d/lora-network-server.
Found lora card MTAC-LORA-868
Starting lora-network-server: OK
admin@mtcdt:/media/sda1/multitech#
</code></pre></li>
</ol>

<p><aside class = 'success'>
    Congratulations, you have successfully updated the <strong>Lora-packet-forwarder</strong> and <strong>Lora-network-server</strong>
</aside></p>
<h1 id='configuring-the-packet-forwarder-for-the-things-network'>Configuring the Packet-Forwarder for The Things Network</h1>
<ol>
<li>Make a new directory: <code class="prettyprint">mkdir /var/config/lora</code></li>
<li>Copy the example network-server configuration to the <code class="prettyprint">lora</code> folder: <code class="prettyprint">cp /opt/lora/lora-network-server.conf.sample /var/config/lora/lora-network-server.conf</code></li>
<li><p>Edit <code class="prettyprint">/var/config/lora/lora-network-server.conf</code> (use <code class="prettyprint">vi</code> or <code class="prettyprint">nano</code>)</p>

<table><thead>
<tr>
<th>Field</th>
<th>MTAC-LORA-915 (NA)</th>
<th>MTAC-LORA-868 (EU)</th>
</tr>
</thead><tbody>
<tr>
<td><strong>lora - frequesncyBand</strong></td>
<td><code class="prettyprint">915</code></td>
<td><code class="prettyprint">868</code></td>
</tr>
<tr>
<td><strong>lora - frequesncySubBand</strong></td>
<td>2</td>
<td><code class="prettyprint">Not applicable</code></td>
</tr>
<tr>
<td><strong>lora - frequesncyEU</strong></td>
<td><code class="prettyprint">Not applicable</code></td>
<td><code class="prettyprint">default: 869500000  range: [863500000 - 867500000] and [869100000 - 869500000]</code></td>
</tr>
<tr>
<td><strong>network[&ldquo;public&rdquo;]</strong></td>
<td><code class="prettyprint">true</code></td>
<td><code class="prettyprint">true</code></td>
</tr>
</tbody></table></li>
<li><p>Restart the network server: <code class="prettyprint">/etc/init.d/lora-network-server restart</code></p></li>
<li><p>Copy the <code class="prettyprint">global_conf.json</code> to the  right directory: <code class="prettyprint">cp /var/run/lora/1/global_conf.json /var/config/lora/</code></p></li>
<li><p>Edit <code class="prettyprint">/etc/config/lora/global_config.json</code> (use <code class="prettyprint">vi</code> or <code class="prettyprint">nano</code>)</p></li>
<li><p>Enter the server address depending on your region:</p>

<ul>
<li><code class="prettyprint">router.eu.staging.thethings.network</code> # EU 433 and EU 863-870</li>
<li><code class="prettyprint">router.us.staging.thethings.network</code> # US 902-928</li>
<li><code class="prettyprint">router.cn.staging.thethings.network</code> # China 470-510 and 779-787</li>
<li><code class="prettyprint">router.au.staging.thethings.network</code> # Australia 915-928 MHz</li>
</ul>
<pre class="highlight plaintext"><code>"gateway_conf" :
{
        "forward_crc_disabled" : true,
        "forward_crc_error" : false,
        "forward_crc_valid" : true,  
        "gateway_ID" : "008000000000a08c",
        "keepalive_interval" : 12,
        "push_timeout_ms" : 120,
        "serv_port_down" : 1700,
        "serv_port_up" : 1700,
        "server_address" : "router.eu.thethings.network",
        "stat_interval" : 20,
        "synch_word" : 52            
}

</code></pre></li>
<li><p>Edit <code class="prettyprint">/etc/init.d/lora-network-server</code> (use <code class="prettyprint">vi</code> or <code class="prettyprint">nano</code>)</p>

<ol>
<li><p>Comment out the LoRa network server start code:</p>
<pre class="highlight plaintext"><code># start network server                  
#start-stop-daemon --start --background --make-pidfile \
#    --pidfile $net_server_pidfile --exec $net_server -- \
#    -c $conf_file --lora-eui $lora_eui --lora-path $run_dir --db $conf_db \
#    --noconsole -l $net_server_log                      
#sleep 1
</code></pre></li>
<li><p>change the -c $run_dir to -c $conf_dir:</p>
<pre class="highlight plaintext"><code># start packet forwarder
start-stop-daemon --start --background --make-pidfile \
    --pidfile $pkt_fwd_pidfile --exec $pkt_fwd -- \
    -c $conf_dir -l $pkt_fwd_log
echo "OK"
</code></pre></li>
<li><p>Comment out the LoRa network server stop code</p>
<pre class="highlight plaintext"><code>#start-stop-daemon --stop --quiet --oknodo --pidfile $net_server_pidfile --retry 15
start-stop-daemon --stop --quiet --oknodo --pidfile $pkt_fwd_pidfile --retry 5
</code></pre></li>
<li><p>Comment out the LoRa network server stop code</p>
<pre class="highlight plaintext"><code>#start-stop-daemon --stop --quiet --oknodo --pidfile $net_server_pidfile --retry 15
start-stop-daemon --stop --quiet --oknodo --pidfile $pkt_fwd_pidfile --retry 5
</code></pre></li>
<li><p>Restart the Packet forwarder: <code class="prettyprint">/etc/init.d/lora-network-server restart</code></p></li>
</ol></li>
</ol>

<p><aside class = 'success'>
    Congratulations, you have configured the gateway
</aside></p>

<p>#Check if the packetforwarder is running</p>

<ol>
<li><p>Check if the gateway is receiving packages: <code class="prettyprint">tail -f /var/log/lora-pkt-fwd-1.log</code></p>
<pre class="highlight plaintext"><code>##### 2016-05-17 15:09:32 GMT #####
### [UPSTREAM] ###
# RF packets received by concentrator: 3
# CRC_OK: 100.00%, CRC_FAIL: 0.00%, NO_CRC: 0.00%
# RF packets forwarded: 3 (75 bytes)
# PUSH_DATA datagrams sent: 3 (738 bytes)
# PUSH_DATA acknowledged: 100.00%
### [DOWNSTREAM] ###
# PULL_DATA sent: 2 (100.00% acknowledged)
# PULL_RESP(onse) datagrams received: 0 (0 bytes)
# RF packets sent to concentrator: 0 (0 bytes)
# TX errors: 0
##### END #####
INFO: [up] PUSH_ACK received in 4 ms
INFO: [down] PULL_ACK received in 6 ms
INFO: [up] PUSH_ACK received in 4 ms
INFO: [up] PUSH_ACK received in 5 ms
</code></pre></li>
</ol>

<p>* <strong>For Upstream</strong></p>

<p>1. <code class="prettyprint">RF packets received by concentrator</code> (packets are stored in concentrator)
        2. <code class="prettyprint">RF packets forwarded</code> (packets are forwarded to The Things Network server)
        3. <code class="prettyprint">PUSH_DATA acknowledged</code> (forwarding acknowledgement)
            * 0% : no active connection to TTN backend
            * 100% : active connection to TTN backend</p>

<p>* <strong>For Downstream</strong></p>

<p>1. <code class="prettyprint">PULL_DATA sent</code> (requesting avaliable downstream packets)
            * 0% : no active connection to TTN backend
            * 100% : active connection to TTN backend<br>
        2. <code class="prettyprint">PULL_RESP(onse) datagrams received</code> (downstream packets)
        3. <code class="prettyprint">RF packets sent to concentrator</code> (concentrator sends downstream packets)</p>

<p><aside class = 'success'>
    Congratulations, if you have similar logs, the gateway works
</aside></p>

      </div>
      <div class="dark-box">
      </div>
    </div>
  </body>
</html>
